---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - github.com/fluxcd/flux2/manifests/install?ref=v2.2.3
helmCharts:
  - name: cilium
    repo: https://helm.cilium.io/
    version: 1.15.1
    releaseName: cilium
    includeCRDs: true
    namespace: kube-system
    valuesInline:
      name: main
      id: 1

      cni:
        exclusive: false

      bgp:
        enabled: false
        announce:
          loadbalancerIP: true
          podCIDR: false

      bgpControlPlane:
        enabled: true

      k8sServiceHost: localhost
      k8sServicePort: 7445

      rollOutCiliumPods: true
      localRedirectPolicy: true

      kubeProxyReplacement: strict
      kubeProxyReplacementHealthzBindAddr: 0.0.0.0:10256

      loadBalancer:
        algorithm: maglev
        mode: dsr

      bandwidthManager:
        enabled: true
        bbr: true
      bpf:
        masquerade: true
        tproxy: true

      l7Proxy: true

      enableCnpStatusUpdates: true
      endpointStatus:
        enabled: true
        status: "policy"

      ipam:
        mode: "kubernetes"

      k8sClientRateLimit:
        burst: 10
        qps: 5

      # https://docs.cilium.io/en/latest/network/l2-announcements/
      l2announcements:
        enabled: true
        leaseDuration: 300s
        leaseRenewDeadline: 60s
        leaseRetryPeriod: 10s

      ingressController:
        enabled: false
        loadbalancerMode: shared

      operator:
        rollOutPods: true

      autoDirectNodeRoutes: true
      ipv4NativeRoutingCIDR: 10.244.0.0/16
      routingMode: native
      containerRuntime:
        integration: containerd

      hubble:
        enabled: true
        serviceMonitor:
          enabled: false

        metrics:
          enabled:
            - dns:query;ignoreAAAA
            - drop
            - tcp
            - flow
            - port-distribution
            - icmp
            - http

        relay:
          enabled: true
          rollOutPods: true

        ui:
          enabled: true
          ingress:
            enabled: false
          rollOutPods: true

      securityContext:
        capabilities:
          ciliumAgent:
            - CHOWN
            - KILL
            - NET_ADMIN
            - NET_RAW
            - IPC_LOCK
            - SYS_ADMIN
            - SYS_RESOURCE
            - DAC_OVERRIDE
            - FOWNER
            - SETGID
            - SETUID
          cleanCiliumState:
            - NET_ADMIN
            - SYS_ADMIN
            - SYS_RESOURCE

      cgroup:
        autoMount:
          enabled: false
        hostRoot: /sys/fs/cgroup
